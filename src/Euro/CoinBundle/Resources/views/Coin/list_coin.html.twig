{% set country = '' %}

{% set empty_cell %}
<td>-</td>
{% endset %}

{% set commemorative %}
<span class="badge-valid badge-success" title="{{ 'coin.commemorative'|trans }}"><i class="icon-white icon-ok"></i></span>
{% endset %}

{% for coin in coins %}
	{% if country != coin.country %}
		{% set country = coin.country %}
		{% if not loop.first %}
				{% for n in range(column + 1, nbval) if column < nbval %}
					{{ empty_cell }}
				{% endfor %}
				</tr>
			</tbody>
			</table>
		{% endif %}

		<table class="table table-bordered table-condensed table-striped">
		<thead>
			<tr>
				<th>{{ coin.country|trans }}</th>
				{% for value in coin_values[coin.country.id] %}
				<th>{{ value }}</th>
				{% endfor %}

				{% set changed, column, year = false, 0, 1990 %}
				{% set nbval, val = coin_values[coin.country.id]|length - 1, coin_values[coin.country.id] %}
			</tr>
		</thead>
		<tbody>
	{% endif %}

	{% if year != coin.year %}
		{% if not loop.first and year != 1990 %}
			{% for n in range(column + 1, nbval) if column < nbval %}
				{{ empty_cell }}
			{% endfor %}
			</tr>
		{% endif %}

	<tr>
		<td>{{ coin.year }}</td>
		{% set changed, column, year = false, 0, coin.year %}
	{% endif %}

	{% if val[column] != coin.value %}
		{% for n in range(column + 1, nbval) %}
			{% if not changed %}
				{{ empty_cell }}
			{% endif %}

			{% if val[n] == coin.value %}
				{% set column = n %}
				{% set changed = true %}
			{% endif %}

			{% if changed and val[n] > coin.value %}
				{{ empty_cell }}
			{% endif %}
		{% endfor %}
	{% else %}
		{% set column = column + 1 %}
	{% endif %}

	<td>
		{% if app.user %}
			{% set uc = 0 %}
			{% for c in app.user.coins if c.coin.id == coin.id %}
				{% set uc = c %}
			{% endfor %}

			{% set quantity = uc ? uc.quantity : 0 %}

			<div class="pull-left">
				<div class="btn-group coin-collection"{% if uc %} data-uc="{{ uc.id }}"{% else %} data-coin="{{ coin.id }}"{% endif %}>
					<button class="btn btn-mini{% if quantity %} btn-danger{% endif %} coin-remove"{% if not uc or uc.quantity == 0 %} disabled="disabled"{% endif %}>-</button>
					<button class="btn btn-mini coin-quantity" disabled="disabled">{{ quantity|number_format }}</button>
					<button class="btn btn-mini btn-success coin-add">+</button>
				</div>
			</div>

			<div class="pull-right">
				<a class="coin-info" href="{{ path('coin_show', { 'id': coin.id }) }}" data-coin="{{ coin.id }}" title="{{ 'information'|trans }}">?</a>
			</div>
		{% else %}
			{% if coin.commemorative %}
				{{ commemorative }}
			{% endif %}

			<a href="{{ path('coin_show', { 'id': coin.id }) }}">{{ coin.mintage|number_format }}</a>
		{% endif %}
	</td>

	{% if loop.last %}
			{% for n in range(column + 1, nbval) if column < nbval %}
				{{ empty_cell }}
			{% endfor %}
			</tr>
		</tbody>
		</table>
	{% endif %}
{% endfor %}
