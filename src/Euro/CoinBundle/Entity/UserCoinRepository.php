<?php

namespace Euro\CoinBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Query\ResultSetMapping;

/**
 * UserCoinRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class UserCoinRepository extends EntityRepository {

	public function getByUser($user) {
		$queryBuiler = $this->createQueryBuilder('uc');
		$expr = $queryBuiler->expr();

		return $queryBuiler
						->join('uc.coin', 'c')
						->join('c.value', 'v')
						->join('c.year', 'y')
						->leftJoin('y.workshop', 'w')
						->where($expr->eq('uc.user', ':user'))
						->orderBy('y.year', 'ASC')
						->addOrderBy('w.short_name', 'ASC')
						->addOrderBy('v.value', 'DESC')
						->setParameter('user', $user)
						->getQuery()
						->getResult();
	}

	public function getDifferentDoublesByUserAndCoin($user, $coin) {
		$rsm = new ResultSetMapping;
		$rsm->addEntityResult('Euro\CoinBundle\Entity\UserCoin', 'uc');

		$rsm->addJoinedEntityResult('Euro\UserBundle\Entity\User', 'u', 'uc', 'user');
		$rsm->addJoinedEntityResult('Euro\CoinBundle\Entity\Coin', 'c', 'uc', 'coin');
		$rsm->addJoinedEntityResult('Euro\CoinBundle\Entity\Value', 'v', 'c', 'value');
		$rsm->addJoinedEntityResult('Euro\CoinBundle\Entity\Year', 'y', 'c', 'year');
		$rsm->addJoinedEntityResult('Euro\CoinBundle\Entity\Workshop', 'w', 'y', 'workshop');
		$rsm->addJoinedEntityResult('Euro\CoinBundle\Entity\Country', 'ct', 'c', 'country');

		$rsm->addFieldResult('uc', 'id', 'id');
		$rsm->addFieldResult('uc', 'quantity', 'quantity');
		$rsm->addFieldResult('u', 'user_id', 'id');
		$rsm->addFieldResult('u', 'username', 'username');
		$rsm->addFieldResult('c', 'coin_id', 'id');
		$rsm->addFieldResult('c', 'commemorative', 'commemorative');
		$rsm->addFieldResult('c', 'mintage', 'mintage');
		$rsm->addFieldResult('c', 'description', 'description');
		$rsm->addFieldResult('v', 'value_id', 'id');
		$rsm->addFieldResult('v', 'value', 'value');
		$rsm->addFieldResult('v', 'collector', 'collector');
		$rsm->addFieldResult('y', 'year_id', 'id');
		$rsm->addFieldResult('y', 'year', 'year');
		$rsm->addFieldResult('w', 'workshop_id', 'id');
		$rsm->addFieldResult('w', 'short_name', 'short_name');
		$rsm->addFieldResult('w', 'name', 'name');
		$rsm->addFieldResult('ct', 'country_id', 'id');
		$rsm->addFieldResult('ct', 'name', 'name');
		$rsm->addFieldResult('ct', 'nameiso', 'nameiso');
		$rsm->addFieldResult('ct', 'join_date', 'join_date');
		$rsm->addFieldResult('ct', 'former_currency_iso', 'former_currency_iso');
		$rsm->addFieldResult('ct', 'exchange_rate', 'exchange_rate');

		return $this->getEntityManager()->createNativeQuery('SELECT uc.id, uc.quantity,
				m.id AS user_id, m.username,
				c.id AS coin_id, c.commemorative, c.mintage, c.description,
				v.id AS value_id, v.value, v.collector,
				y.id AS year_id, y.year,
				w.id AS workshop_id, w.short_name, w.name,
				ct.id AS country_id, ct.name, ct.nameiso, ct.join_date, ct.former_currency_iso, ct.exchange_rate
			FROM user_coin uc
			JOIN coin c ON c.id = uc.coin_id
			JOIN country ct ON ct.id = c.country_id
			JOIN value v ON v.id = c.value_id
			JOIN year y ON y.id = c.year_id
			JOIN workshop w ON w.id = y.workshop_id
			JOIN member m ON m.id = uc.user_id
			JOIN user_coin uc2 ON uc2.user_id = :user
			WHERE uc.user_id <> uc2.user_id
				AND uc.coin_id <> uc2.coin_id
				AND uc.coin_id <> :coin
				AND uc.quantity > 1
				AND uc2.quantity > 0
			ORDER BY m.username ASC,
				y.year ASC,
				w.short_name ASC,
				v.value DESC', $rsm)
						->setParameter('user', $user->getId())
						->setParameter('coin', $coin)
						->getResult();
	}

	public function getDoublesByUser($user) {
		$queryBuiler = $this->createQueryBuilder('uc');
		$expr = $queryBuiler->expr();

		return $queryBuiler
						->join('uc.coin', 'c')
						->join('c.value', 'v')
						->join('c.year', 'y')
						->leftJoin('y.workshop', 'w')
						->where($expr->eq('uc.user', ':user'))
						->andWhere($expr->gt('uc.quantity', 1))
						->orderBy('y.year', 'ASC')
						->addOrderBy('w.short_name', 'ASC')
						->addOrderBy('v.value', 'DESC')
						->setParameter('user', $user)
						->getQuery()
						->getResult();
	}

}
